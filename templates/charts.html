{% extends 'base.html' %}

{% block title %}Charts - Data Analytics Dashboard{% endblock %}

{% block content %}
<div class="mb-4">
    <h1>üìà Interactive Charts & Visualizations</h1>
    <p class="text-muted">Explore your data with interactive plotly charts and static matplotlib visualizations</p>
</div>

<!-- Timeseries Controls -->
<div class="card mb-4">
    <div class="card-header">
        <h3 class="mb-0">‚öôÔ∏è Chart Controls</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="freq-select">Aggregation Frequency:</label>
                    <select id="freq-select" class="form-control" onchange="updateCharts()">
                        <option value="H">Hourly</option>
                        <option value="D" selected>Daily</option>
                        <option value="W">Weekly</option>
                        <option value="M">Monthly</option>
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="days-select">Date Range:</label>
                    <select id="days-select" class="form-control" onchange="updateCharts()">
                        <option value="7">Last 7 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Timeseries Chart -->
<div class="chart-container">
    <h2 class="chart-title">üìä Timeseries Analysis</h2>
    <div id="timeseries-plot" style="height: 500px;"></div>
</div>

<!-- Category Distribution -->
<div class="chart-container">
    <h2 class="chart-title">üìä Value by Category</h2>
    <div id="category-plot" style="height: 400px;"></div>
</div>

<!-- Static Matplotlib Chart -->
<div class="chart-container">
    <h2 class="chart-title">üìà Daily Values (Static Chart)</h2>
    <div style="text-align: center;">
        <img id="static-chart" src="/static_timeseries.png" alt="Daily Timeseries" class="img-fluid" style="max-width: 100%; border-radius: 0.5rem;">
    </div>
    <div class="mt-3">
        <button class="btn btn-secondary btn-sm" onclick="location.href='/static_timeseries.png'">
            Download Chart
        </button>
    </div>
</div>

<!-- Data Statistics -->
<div class="card">
    <div class="card-header">
        <h3 class="mb-0">üìä Data Statistics</h3>
    </div>
    <div class="card-body" id="stats-container">
        <div class="spinner"></div>
    </div>
</div>

<script>
    async function loadStats() {
        try {
            const response = await fetch('/api/stats');
            const stats = await response.json();
            
            let statsHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Total Records:</strong> ${stats.total_records}</p>
                        <p><strong>Total Value:</strong> $${stats.total_value.toFixed(2)}</p>
                        <p><strong>Average Value:</strong> $${stats.average_value.toFixed(2)}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Categories:</strong> ${stats.categories_count}</p>
                        <p><strong>Date Range:</strong><br>
                        ${stats.date_range.start ? stats.date_range.start.split('T')[0] : 'N/A'} to ${stats.date_range.end ? stats.date_range.end.split('T')[0] : 'N/A'}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('stats-container').innerHTML = statsHtml;
        } catch (error) {
            console.error('Error loading stats:', error);
            document.getElementById('stats-container').innerHTML = '<p class="text-danger">Error loading statistics</p>';
        }
    }

    async function updateCharts() {
        const freq = document.getElementById('freq-select').value;
        const days = document.getElementById('days-select').value;
        
        try {
            // Load timeseries
            const tsResponse = await fetch(`/api/plotly_timeseries?freq=${freq}&days=${days}`);
            const tsData = await tsResponse.json();
            const tsFig = JSON.parse(JSON.stringify(tsData));
            Plotly.react('timeseries-plot', tsFig.data, tsFig.layout || {}, {responsive: true});
        } catch (error) {
            console.error('Error loading timeseries:', error);
            document.getElementById('timeseries-plot').innerHTML = '<p class="text-danger">Error loading chart</p>';
        }
    }

    async function loadCategoryChart() {
        try {
            const response = await fetch('/api/plotly_category_distribution');
            const data = await response.json();
            const fig = JSON.parse(JSON.stringify(data));
            Plotly.react('category-plot', fig.data, fig.layout || {}, {responsive: true});
        } catch (error) {
            console.error('Error loading category chart:', error);
            document.getElementById('category-plot').innerHTML = '<p class="text-danger">Error loading chart</p>';
        }
    }

    // Load all charts on page load
    document.addEventListener('DOMContentLoaded', () => {
        updateCharts();
        loadCategoryChart();
        loadStats();
    });
</script>
{% endblock %}
